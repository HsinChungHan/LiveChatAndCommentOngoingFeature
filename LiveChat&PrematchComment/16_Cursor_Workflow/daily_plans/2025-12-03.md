# å·¥ä½œè¨ˆåŠƒ - 2025-12-03

**ç”Ÿæˆæ™‚é–“**: 2025-12-02ï¼ˆDaily End æµç¨‹ï¼‰

## ğŸ“‹ ä»Šæ—¥ç›®æ¨™

### å„ªå…ˆç´š 1ï¼šè¨­è¨ˆèˆ‡å¯¦ä½œ ChatWebSocketClientï¼ˆé«˜å„ªå…ˆç´šï¼‰

- [ ] **TDD-022**: ChatWebSocketClientï¼ˆWebSocketï¼‰è¨­è¨ˆèˆ‡å¯¦ä½œ
  - **æ™‚é–“ç¯„åœ**: 2025-12-03 ~ 2025-12-05
  - **Story Point**: 13
  - **ä¼°æ™‚**: æ¨™æº– 5 å¤©ï¼Œæœ€åš´å² 3 å¤©
  - **ä¾è³´**: TDD-011 (ChatAPI) âœ… å·²å®Œæˆ
  - **æª”æ¡ˆ**: `MatchChat/Sources/MatchChat/Services/API/ChatWebSocketClient.swift`
  - **åƒè€ƒå¯¦ä½œ**:
    - `WebSocketStompManager.swift` - ä½¿ç”¨ SportyStompï¼Œdelegate pattern
    - `EventDetail.WebSocketFeature` - TCA + AsyncStream æ¨¡å¼
    - `EventOddsWebSocketManager` - å¤šè¨‚é–±è€…ç®¡ç†ï¼ŒAsyncStream
  - **è¨­è¨ˆé‡é»**:
    - ä½¿ç”¨ `actor` ç¢ºä¿ç·šç¨‹å®‰å…¨
    - ä½¿ç”¨ `AsyncStream` æä¾›è¨Šæ¯æµï¼ˆåƒè€ƒ EventDetail æ¨¡å¼ï¼‰
    - æ•´åˆ SportyStomp æ¡†æ¶ï¼ˆåƒè€ƒ WebSocketStompManagerï¼‰
    - å¯¦ä½œé€£ç·šç®¡ç†ï¼ˆé‡é€£ã€å¿ƒè·³ç­‰ï¼‰
    - å¯¦ä½œè¨‚é–± / å–æ¶ˆè¨‚é–±ï¼ˆæ”¯æ´å¤šå€‹ chatroomï¼‰
    - å¯¦ä½œè¨Šæ¯æ¥æ”¶èˆ‡ç™¼é€
    - å¯¦ä½œæŒ‡æ•¸é€€é¿é‡é€£ç­–ç•¥
  - **å‚™è¨»**: 
    - åƒè€ƒç¾æœ‰å°ˆæ¡ˆä¸­çš„ WebSocket å¯¦ä½œæ¨¡å¼
    - éœ€è¦æ•´åˆ SportyStomp æ¡†æ¶
    - è€ƒæ…®ä½¿ç”¨ AsyncStream è€Œé callbackï¼Œä»¥ç¬¦åˆç¾ä»£ Swift ä¸¦ç™¼æ¨¡å¼

### å„ªå…ˆç´š 2ï¼šæ–‡æª”å®Œå–„ï¼ˆä½å„ªå…ˆç´šï¼‰

- [ ] æ›´æ–°æ¶æ§‹åœ–ä»¥åæ˜  Client èˆ‡ API å±¤çš„å¯¦éš›é—œä¿‚
- [ ] åœ¨ TDD æ–‡ä»¶ä¸­è¨»æ˜å¯¦éš›å°ˆæ¡ˆçµæ§‹å·®ç•°ï¼ˆMatchChat çµ±ä¸€ packageï¼‰

## ğŸ¤– èˆ‡ Cursor çš„å”ä½œè¨ˆåŠƒ

### é–‹å§‹å¯¦ä½œå‰

è«‹ Cursor å”åŠ©ï¼š
1. è®€å– TDD-022 æ–‡ä»¶ï¼ˆChatWebSocketClientï¼‰
2. åˆ†æåƒè€ƒå¯¦ä½œï¼š
   - `WebSocketStompManager.swift` - äº†è§£ SportyStomp çš„ä½¿ç”¨æ–¹å¼
   - `EventDetail.WebSocketFeature` - äº†è§£ TCA + AsyncStream æ¨¡å¼
   - `EventOddsWebSocketManager` - äº†è§£å¤šè¨‚é–±è€…ç®¡ç†ç­–ç•¥
3. è¨­è¨ˆ ChatWebSocketClient æ¶æ§‹ï¼š
   - æ±ºå®šä½¿ç”¨ `actor` é‚„æ˜¯ `class`ï¼ˆåƒè€ƒç¾æœ‰å¯¦ä½œï¼‰
   - æ±ºå®šä½¿ç”¨ `AsyncStream` é‚„æ˜¯ callbackï¼ˆå»ºè­°ä½¿ç”¨ AsyncStreamï¼‰
   - è¨­è¨ˆé€£ç·šç‹€æ…‹ç®¡ç†
   - è¨­è¨ˆé‡é€£ç­–ç•¥ï¼ˆæŒ‡æ•¸é€€é¿ï¼‰
   - è¨­è¨ˆå¿ƒè·³æ©Ÿåˆ¶
4. æª¢æŸ¥ä¾è³´é—œä¿‚ï¼š
   - ChatAPI.WebSocketEndpoint å·²å®šç¾© âœ…
   - ChatAPI.WebSocketMessageDTO å·²å®šç¾© âœ…
   - éœ€è¦ç¢ºèª SportyStomp æ˜¯å¦å¯ç”¨

### å¯¦ä½œéç¨‹ä¸­

- éš¨æ™‚èˆ‡ Cursor è¨è«–å¯¦ä½œç´°ç¯€
- è¨˜éŒ„é‡è¦çš„æ±ºç­–å’Œå°è©±ï¼ˆ**è¨˜å¾—åŠ å…¥ User Prompt æ¬„ä½**ï¼‰
- é‡åˆ°å•é¡Œæ™‚è«‹ Cursor å”åŠ©è§£æ±º
- ç‰¹åˆ¥æ³¨æ„ï¼š
  - WebSocket çš„ä¸¦ç™¼å®‰å…¨ï¼ˆä½¿ç”¨ actor æˆ–é©ç•¶çš„é–æ©Ÿåˆ¶ï¼‰
  - éŒ¯èª¤è™•ç†å’Œé‡é€£é‚è¼¯
  - å¤šè¨‚é–±è€…ç®¡ç†ï¼ˆåƒè€ƒ EventOddsWebSocketManagerï¼‰
  - AsyncStream çš„ç”Ÿå‘½é€±æœŸç®¡ç†

### å¯¦ä½œå®Œæˆå¾Œ

è«‹ Cursor å”åŠ©ï¼š
1. æª¢æŸ¥å¯¦ä½œæ˜¯å¦ç¬¦åˆ TDD è¦ç¯„
2. æª¢æŸ¥æ˜¯å¦æœ‰éºæ¼çš„åŠŸèƒ½
3. æä¾›æ”¹é€²å»ºè­°
4. æ›´æ–°ç›¸é—œæ–‡ä»¶

## ğŸ“ å·¥ä½œè¨˜éŒ„

### èˆ‡ Cursor çš„é‡è¦å°è©±

ï¼ˆåœ¨æ­¤è¨˜éŒ„èˆ‡ Cursor çš„é‡è¦å°è©±å’Œæ±ºç­–ï¼‰

### å¯¦ä½œé€²åº¦

ï¼ˆåœ¨æ­¤è¨˜éŒ„å¯¦ä½œé€²åº¦ï¼‰

### é‡åˆ°çš„å•é¡Œ

ï¼ˆåœ¨æ­¤è¨˜éŒ„é‡åˆ°çš„å•é¡Œå’Œè§£æ±ºæ–¹æ¡ˆï¼‰

## ğŸ’¡ è¨­è¨ˆå»ºè­°

### æ¶æ§‹è¨­è¨ˆåƒè€ƒ

#### 1. åƒè€ƒ WebSocketStompManager.swift
- **ä½¿ç”¨ SportyStomp æ¡†æ¶**: å°ˆæ¡ˆå·²æœ‰ SportyStompï¼Œæ‡‰ç›´æ¥ä½¿ç”¨
- **Delegate Pattern**: ä½¿ç”¨ `SwiftStompDelegate` è™•ç†é€£ç·šäº‹ä»¶
- **é€£ç·šç®¡ç†**: åœ¨ `init` ä¸­å»ºç«‹é€£ç·šï¼Œä½¿ç”¨ `enableAutoPing()` å•Ÿç”¨å¿ƒè·³
- **è¨‚é–±æ©Ÿåˆ¶**: ä½¿ç”¨ `swiftStomp.subscribe(to:id:headers:)` è¨‚é–± topic

#### 2. åƒè€ƒ EventDetail.WebSocketFeature
- **AsyncStream æ¨¡å¼**: ä½¿ç”¨ `AsyncStream` æä¾›è¨Šæ¯æµï¼Œè€Œé callback
- **TCA æ•´åˆ**: åœ¨ Feature ä¸­ä½¿ç”¨ `.run { send in ... }` è™•ç† AsyncStream
- **ç”Ÿå‘½é€±æœŸç®¡ç†**: ä½¿ç”¨ `cancellable(id:)` ç®¡ç†è¨‚é–±ç”Ÿå‘½é€±æœŸ

#### 3. åƒè€ƒ EventOddsWebSocketManager
- **å¤šè¨‚é–±è€…ç®¡ç†**: ä½¿ç”¨ `NSLock` ä¿è­·å…±äº«ç‹€æ…‹
- **è¨‚é–±è€…è¿½è¹¤**: ä½¿ç”¨ UUID è¿½è¹¤æ¯å€‹è¨‚é–±è€…
- **å»£æ’­æ©Ÿåˆ¶**: å°‡è¨Šæ¯å»£æ’­çµ¦æ‰€æœ‰è¨‚é–±è€…

### å»ºè­°çš„è¨­è¨ˆæ–¹æ¡ˆ

```swift
// æ–¹æ¡ˆ 1: ä½¿ç”¨ actor + AsyncStreamï¼ˆæ¨è–¦ï¼‰
public actor ChatWebSocketClient {
    private var swiftStomp: SportyStomp?
    private var messageStreams: [String: AsyncStream<ChatAPI.WebSocketMessageDTO>.Continuation] = [:]
    
    public func subscribe(chatroomId: String) -> AsyncStream<ChatAPI.WebSocketMessageDTO> {
        // è¿”å› AsyncStream
    }
}

// æ–¹æ¡ˆ 2: ä½¿ç”¨ class + NSLockï¼ˆåƒè€ƒ EventOddsWebSocketManagerï¼‰
public final class ChatWebSocketClient {
    private let lock = NSLock()
    private var subscriptions: [String: Subscription] = [:]
    
    public func subscribe(chatroomId: String) -> AsyncStream<ChatAPI.WebSocketMessageDTO> {
        // è¿”å› AsyncStream
    }
}
```

### å¯¦ä½œé †åº
1. **ä¸Šåˆ**: åˆ†æåƒè€ƒå¯¦ä½œï¼Œè¨­è¨ˆ ChatWebSocketClient æ¶æ§‹
2. **ä¸‹åˆ**: é–‹å§‹å¯¦ä½œ ChatWebSocketClientï¼ˆTDD-022ï¼‰

### æ³¨æ„äº‹é …
- ChatWebSocketClient æ˜¯è¼ƒè¤‡é›œçš„å¯¦ä½œï¼Œéœ€è¦ä»”ç´°è¨­è¨ˆ
- å„ªå…ˆè€ƒæ…®ä½¿ç”¨ `AsyncStream` è€Œé callbackï¼Œç¬¦åˆç¾ä»£ Swift ä¸¦ç™¼æ¨¡å¼
- æ³¨æ„ WebSocket çš„ä¸¦ç™¼å®‰å…¨ï¼ˆä½¿ç”¨ actor æˆ– NSLockï¼‰
- åƒè€ƒç¾æœ‰å°ˆæ¡ˆçš„å¯¦ä½œæ¨¡å¼ï¼Œä¿æŒä¸€è‡´æ€§
- ç¢ºèª SportyStomp çš„å¯ç”¨æ€§å’Œ API

## ğŸ”— ç›¸é—œæ–‡ä»¶

- [TDD-022: ChatWebSocketClient](../../12_Tickets/03_client/TDD-022_ChatWebSocketClient.md)
- [ChatWebSocketClient è¨­è¨ˆæ–¹æ¡ˆ](./2025-12-03_websocket_design.md) - **è¨­è¨ˆæ–‡æª”**
- [TDD-020: PrematchCommentClient](../../12_Tickets/03_client/TDD-020_PrematchCommentClient.md)
- [TDD-021: LiveChatClient](../../12_Tickets/03_client/TDD-021_LiveChatClient.md)
- [å¯¦ä½œç‹€æ…‹](../../13_Implementation_Status/implementation_status.md)
- [Changelog](../../14_Changelog/CHANGELOG.md)

## ğŸ“š åƒè€ƒå¯¦ä½œ

- [WebSocketStompManager.swift](../../../Input/LiveChat&PrematchComment/CodeRef/WebSocketStompManager.swift) - SportyStomp ä½¿ç”¨ç¯„ä¾‹
- [EventDetail.WebSocketFeature](../../../../FCom/Home Tab/EventDetail/EventDetail/Feature/EventDetail+Feature+WebSocket.swift) - TCA + AsyncStream æ¨¡å¼
- [EventOddsWebSocketManager](../../../../FCom/Home Tab/EventDetail/EventDetail/Service/EventOddsWebSocketManager.swift) - å¤šè¨‚é–±è€…ç®¡ç†ç­–ç•¥

