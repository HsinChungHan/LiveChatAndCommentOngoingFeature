# 2025-12-04 å°è©±çµ±æ•´

## ğŸ“… å°è©±è³‡è¨Š

- **æ—¥æœŸ**: 2025-12-04
- **ä¸»é¡Œ**: Data Layer é‡æ§‹èˆ‡ TDD æ–‡ä»¶åŒæ­¥
- **Jira Tickets**: FOOTBALL-9180-9184
- **å°è©±æ™‚é•·**: å…¨å¤©
- **ä¸»è¦æˆå°±**: å®Œæˆ 4 å€‹ commits + TDD æ–‡ä»¶æ›´æ–°

---

## ğŸ¯ é‡è¦æ±ºç­–

### æ±ºç­– 1: Git é…ç½®æœ¬åœ°åŒ–ç­–ç•¥

**èƒŒæ™¯**: 
- `buildServer.json` æ˜¯æœ¬åœ° Xcode Build Server é…ç½®
- éœ€è¦åœ¨ rebase/merge æ™‚ä¿ç•™

**æ±ºç­–**: 
- å°‡ `buildServer.json` åŠ å…¥ `.gitignore`
- é¸æ“‡æ–¹æ¡ˆ 1ï¼ˆåœ˜éšŠå…±äº«è¦å‰‡ï¼‰è€Œéæ–¹æ¡ˆ 2ï¼ˆå€‹äºº `.git/info/exclude`ï¼‰

**ç†ç”±**:
- `buildServer.json` æœ¬ä¾†å°±æ‡‰è©²æ˜¯æ¯å€‹äººçš„æœ¬åœ°è¨­å®š
- åŠ åˆ° `.gitignore` å°åœ˜éšŠä¾†èªªæ›´åˆç†
- é¡ä¼¼ `.vscode/settings.json` çš„è™•ç†æ–¹å¼

**å½±éŸ¿**: 
- âœ… æ‰€æœ‰ branch éƒ½æœƒå°Šé‡é€™å€‹è¦å‰‡
- âœ… Rebase/merge develop ä¸æœƒæœ‰è¡çª
- âœ… åœ˜éšŠæˆå“¡å—ç›Š

---

### æ±ºç­– 2: å¼•å…¥ SharedBetsMetadata åŒ…è£å‹åˆ¥

**å•é¡Œåˆ†æ**:
```
âŒ åŸå§‹å¯¦ä½œ:
publishComment(..., sharedBetsMeta: [String: Any]?, ...)
                                      â†‘
                          ä¸ç¬¦åˆ Sendable å”è­°

âš ï¸ ç·¨è­¯å™¨è­¦å‘Š:
warning: passing non-sendable type '[String: Any]?' 
         across actor boundary
```

**è§£æ±ºæ–¹æ¡ˆ**:
```swift
public struct SharedBetsMetadata: @unchecked Sendable {
    public let value: [String: Any]
    
    public init(_ value: [String: Any]) {
        self.value = value
    }
}
```

**è¨­è¨ˆæ¶æ§‹**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client Layer                                    â”‚
â”‚ publishComment(..., sharedBetsMeta: SharedBets  â”‚
â”‚                     Metadata?, ...)             â”‚
â”‚         â†“ ç¬¦åˆ Sendable                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Repository Layer                                â”‚
â”‚ publishComment(..., sharedBetsMeta: SharedBets  â”‚
â”‚                     Metadata?, ...)             â”‚
â”‚         â†“ è§£åŒ…: metaDict = sharedBetsMeta.value â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Endpoint/API Layer                              â”‚
â”‚ publishComment(..., sharedBetsMeta: [String:    â”‚
â”‚                     Any]?, ...)                 â”‚
â”‚         â†“ JSON åºåˆ—åŒ–                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Network                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å„ªé»**:
- âœ… è§£æ±º Swift Concurrency è­¦å‘Š
- âœ… æå‡å‹åˆ¥å®‰å…¨æ€§
- âœ… æ˜ç¢ºæ„åœ–ï¼Œå°è£å¯¦ä½œç´°ç¯€
- âœ… æœªä¾†å¯æ“´å±•ï¼ˆå¯å¢åŠ é©—è­‰é‚è¼¯ï¼‰

**é™åˆ¶èˆ‡è€ƒé‡**:
- âš ï¸ ä½¿ç”¨ `@unchecked Sendable`ï¼ˆéœ€è¦é–‹ç™¼è€…ç¢ºä¿å®‰å…¨æ€§ï¼‰
- âš ï¸ Breaking Changeï¼ˆèª¿ç”¨æ–¹éœ€æ›´æ–°ï¼‰
- âœ… ä½†æ”¹é€²æ˜¯å€¼å¾—çš„

---

### æ±ºç­– 3: ChatWebSocketClient.subscribe nonisolated åŒ–

**å•é¡Œåˆ†æ**:
```swift
// âŒ åŸå§‹å¯¦ä½œï¼ˆActor-isolatedï¼‰
public actor ChatWebSocketClient {
    public func subscribe(chatroomId: String) 
        -> AsyncStream<ChatAPI.WebSocketMessageDTO> {
        // ... å‰µå»ºå’Œè¿”å› AsyncStream
    }
}

// èª¿ç”¨æ™‚éœ€è¦ await
let stream = await client.subscribe(chatroomId: id)
                  â†‘ éœ€è¦ awaitï¼Œèª¿ç”¨æ–¹å¿…é ˆåœ¨ async context
```

**è§£æ±ºæ–¹æ¡ˆ**:
```swift
// âœ… æ”¹é€²å¯¦ä½œï¼ˆnonisolatedï¼‰
public actor ChatWebSocketClient {
    public nonisolated func subscribe(chatroomId: String) 
        -> AsyncStream<ChatAPI.WebSocketMessageDTO> {
        AsyncStream { continuation in
            Task {
                await self.performSubscribe(
                    chatroomId: chatroomId,
                    continuation: continuation
                )
            }
        }
    }
    
    private func performSubscribe(
        chatroomId: String,
        continuation: AsyncStream<...>.Continuation
    ) {
        // Actor-isolated è¨‚é–±é‚è¼¯
    }
}

// èª¿ç”¨æ™‚ä¸éœ€è¦ await
let stream = client.subscribe(chatroomId: id)
             â†‘ åŒæ­¥å‰µå»º AsyncStream
```

**è¨­è¨ˆåŸç†**:
1. `nonisolated` æ–¹æ³•å¯åŒæ­¥åŸ·è¡Œ
2. `AsyncStream` åœ¨åˆå§‹åŒ–æ™‚åŒæ­¥å‰µå»º
3. å¯¦éš›è¨‚é–±é‚è¼¯åœ¨ `Task` ä¸­ç•°æ­¥åŸ·è¡Œï¼ˆactor-isolatedï¼‰
4. ä¿æŒç·šç¨‹å®‰å…¨ï¼Œæ”¹å–„ API æ˜“ç”¨æ€§

**åƒè€ƒ**:
- Apple AsyncStream è¨­è¨ˆæ¨¡å¼
- EventOddsWebSocketManager å¯¦ä½œ

**å„ªé»**:
- âœ… åŒæ­¥å‰µå»º AsyncStreamï¼Œæ”¹å–„ API æ˜“ç”¨æ€§
- âœ… å¯¦éš›é‚è¼¯ä»åœ¨ actor å…§åŸ·è¡Œï¼Œä¿æŒç·šç¨‹å®‰å…¨
- âœ… ç¬¦åˆ Swift Concurrency æœ€ä½³å¯¦è¸
- âœ… å‘å¾Œå…¼å®¹ï¼ˆå¯é¸æ“‡æ€§ç§»é™¤ awaitï¼‰

---

### æ±ºç­– 4: TDD æ–‡ä»¶åŒæ­¥æ›´æ–°ç­–ç•¥

**å•é¡Œ**:
- å¯¦ä½œåŒ…å«å„ªæ–¼åŸ TDD çš„è¨­è¨ˆæ”¹é€²
- TDD æ–‡ä»¶æœªåæ˜ é€™äº›æ”¹é€²
- å¯èƒ½å°è‡´å¾ŒçºŒé–‹ç™¼è€…å›°æƒ‘

**æ±ºç­–**: 
ä¸»å‹•æ›´æ–° TDD æ–‡ä»¶ä»¥åæ˜ å¯¦ä½œæ”¹é€²

**æ›´æ–°åŸå‰‡**:
```
âœ… æ‡‰è©²æ›´æ–°çš„æƒ…æ³ï¼š
1. å¯¦ä½œå¼•å…¥æ›´å¥½çš„å‹åˆ¥å®‰å…¨ï¼ˆå¦‚ Sendable åŒ…è£ï¼‰
2. å¯¦ä½œæ”¹å–„ä½µç™¼æ¨¡å‹ï¼ˆå¦‚ nonisolatedï¼‰
3. å¯¦ä½œéµå¾ªæ›´å¥½çš„è¨­è¨ˆæ¨¡å¼ï¼ˆå¦‚ Protocol é‡æ§‹ï¼‰
4. TDD ä¸­çš„å‹åˆ¥æˆ– API ä¸ç¬¦åˆå¯¦éš›éœ€æ±‚
5. å¯¦ä½œä¿®æ­£äº† TDD ä¸­çš„éŒ¯èª¤

âŒ ä¸æ‡‰æ›´æ–°çš„æƒ…æ³ï¼š
1. å¯¦ä½œåªæ˜¯å·æ‡¶æˆ–èµ°æ·å¾‘
2. å¯¦ä½œé™ä½äº†ç¨‹å¼ç¢¼å“è³ª
3. å¯¦ä½œé•åæ¶æ§‹åŸå‰‡
4. åƒ…åƒ…æ˜¯å‘½åæˆ–æ ¼å¼å·®ç•°
```

**åŸ·è¡Œæ­¥é©Ÿ**:
1. è­˜åˆ¥æ‰€æœ‰å—å½±éŸ¿çš„ TDD tickets
2. æ›´æ–°ç¨‹å¼ç¢¼ç¯„ä¾‹
3. æ›´æ–°å‘½åè¦ç¯„èªªæ˜
4. è¨˜éŒ„è¨­è¨ˆæ±ºç­–ï¼ˆç‚ºä½•åé›¢åŸ TDDï¼‰
5. ç”Ÿæˆ TDD æ›´æ–°è¨˜éŒ„æ–‡æª”

**æ›´æ–°çš„ Tickets**:
- TDD-010: PrematchCommentAPI
- TDD-020: PrematchCommentClient  
- TDD-022: ChatWebSocketClient

**è¼¸å‡ºæ–‡æª”**:
- `tdd_updates_2025-12-05.md` - è©³ç´°æ›´æ–°è¨˜éŒ„

---

### æ±ºç­– 5: Commit æ‹†åˆ†ç­–ç•¥

**åŸå‰‡**: æŒ‰é‚è¼¯åŠŸèƒ½æ‹†åˆ†ï¼Œè€ŒéæŒ‰æª”æ¡ˆæ‹†åˆ†

**å¯¦éš›æ‹†åˆ†**:
```
1. chore: update gitignore to exclude buildServer.json
   â†³ ä¸ç›¸é—œæ–¼ ticketï¼Œç¨ç«‹ commit

2. refactor: wrap shared bets metadata in sendable type
   [FOOTBALL-9180-9184]
   â†³ Sendable å‹åˆ¥åŒ…è£é‡æ§‹

3. refactor: make websocket subscribe method nonisolated
   [FOOTBALL-9180-9184]
   â†³ WebSocket ä½µç™¼æ”¹é€²

4. chore: update xcode project configuration
   [FOOTBALL-9180-9184]
   â†³ é …ç›®é…ç½®æ›´æ–°
```

**è©•ä¼°**: 
- âœ… æ¯å€‹ commit ä»£è¡¨ä¸€å€‹é‚è¼¯è®Šæ›´
- âœ… å®¹æ˜“ review
- âœ… å®¹æ˜“ cherry-pick æˆ– revert
- âœ… ç¬¦åˆ Conventional Commits

---

## ğŸ’¡ å­¸ç¿’è¦é»

### 1. Swift Concurrency æ·±åº¦ç†è§£

#### Sendable å”è­°çš„æ­£ç¢ºæ‡‰ç”¨
```swift
// âŒ éŒ¯èª¤ï¼šç›´æ¥ä½¿ç”¨ non-Sendable å‹åˆ¥
func method(data: [String: Any]) async { }

// âœ… æ­£ç¢ºï¼šåŒ…è£æˆ Sendable
struct DataWrapper: @unchecked Sendable {
    let value: [String: Any]
}
func method(data: DataWrapper) async { }
```

**ä½•æ™‚ä½¿ç”¨ `@unchecked Sendable`**:
- åŒ…è£ Foundation å‹åˆ¥ï¼ˆå¦‚ Dictionaryï¼‰
- ç¢ºä¿å¯¦éš›ä½¿ç”¨æ˜¯ç·šç¨‹å®‰å…¨çš„
- ç„¡æ³•ä¿®æ”¹å‹åˆ¥æœ¬èº«æ™‚ï¼ˆå¦‚ç¬¬ä¸‰æ–¹åº«ï¼‰

#### Actor Isolation çš„ç´°å¾®å·®åˆ¥
```swift
public actor MyActor {
    // Actor-isolated: éœ€è¦ await
    public func method1() -> String { "value" }
    
    // Nonisolated: ä¸éœ€è¦ await
    public nonisolated func method2() -> String { "value" }
}

// ä½¿ç”¨
let value1 = await actor.method1()  // éœ€è¦ await
let value2 = actor.method2()         // ä¸éœ€è¦ await
```

**ä½¿ç”¨ nonisolated çš„æ™‚æ©Ÿ**:
- è¿”å›å€¼ä¸ä¾è³´ actor å…§éƒ¨ç‹€æ…‹
- éœ€è¦åŒæ­¥å‰µå»ºæŸäº›ç‰©ä»¶ï¼ˆå¦‚ AsyncStreamï¼‰
- æä¾›æ›´å¥½çš„ API æ˜“ç”¨æ€§

---

### 2. Git å·¥ä½œæµç¨‹æœ€ä½³å¯¦è¸

#### .gitignore ç­–ç•¥
```
æ–¹æ¡ˆ 1: .gitignoreï¼ˆåœ˜éšŠå…±äº«ï¼‰
âœ… å„ªé»ï¼šæ‰€æœ‰äººå—ç›Šï¼Œè¦å‰‡ä¸€è‡´
âœ… é©ç”¨ï¼šæœ¬å°±æ‡‰è©²æ˜¯æœ¬åœ°é…ç½®çš„æª”æ¡ˆ

æ–¹æ¡ˆ 2: .git/info/excludeï¼ˆå€‹äººï¼‰
âœ… å„ªé»ï¼šä¸å½±éŸ¿å…¶ä»–äºº
âœ… é©ç”¨ï¼šç´”å€‹äººåå¥½çš„å¿½ç•¥è¦å‰‡
```

#### Commit Message è¦ç¯„
```
æ ¼å¼ï¼š<type>: <description> [TICKET-ID]

Type é¡å‹ï¼š
- feat: æ–°åŠŸèƒ½
- fix: Bug ä¿®å¾©
- refactor: é‡æ§‹
- chore: é›œé …ï¼ˆé…ç½®ã€å·¥å…·ç­‰ï¼‰
- docs: æ–‡ä»¶æ›´æ–°
- style: æ ¼å¼èª¿æ•´
- test: æ¸¬è©¦ç›¸é—œ
- perf: æ•ˆèƒ½å„ªåŒ–
```

---

### 3. TDD æ–‡ä»¶ç®¡ç†å“²å­¸

#### æ–‡ä»¶èˆ‡å¯¦ä½œçš„é—œä¿‚
```
TDD æ–‡ä»¶ â†â†’ å¯¦ä½œç¨‹å¼ç¢¼
   â†“           â†“
 æ‡‰è©²æ˜¯      å¯ä»¥è¶…è¶Š
 æŒ‡å°       ä¸¦å›é¥‹
   â†‘           â†“
   â””â”€â”€â”€ äº’ç›¸æ¼”é€² â”€â”€â”€â”˜
```

**é—œéµåŸå‰‡**:
1. TDD æ–‡ä»¶ä¸æ˜¯è–ç¶“ï¼Œå¯ä»¥ä¿®æ­£
2. å¯¦ä½œæ”¹é€²æ‡‰è©²å›é¥‹åˆ° TDD
3. ä¿æŒæ–‡ä»¶èˆ‡å¯¦ä½œåŒæ­¥å¾ˆé‡è¦
4. è¨˜éŒ„ç‚ºä½•åé›¢åŸ TDD

#### è¨­è¨ˆæ±ºç­–è¨˜éŒ„çš„é‡è¦æ€§
```markdown
## æ±ºç­– X: æ¨™é¡Œ

**èƒŒæ™¯**: ç‚ºä½•éœ€è¦åšæ±ºç­–
**æ±ºç­–**: åšäº†ä»€éº¼æ±ºå®š
**ç†ç”±**: ç‚ºä½•é¸æ“‡é€™å€‹æ–¹æ¡ˆ
**å½±éŸ¿**: æœ‰ä»€éº¼å½±éŸ¿å’Œé™åˆ¶
**æ›¿ä»£æ–¹æ¡ˆ**: è€ƒæ…®éä½†æœªæ¡ç”¨çš„æ–¹æ¡ˆ
```

---

### 4. æ¶æ§‹è¨­è¨ˆåŸå‰‡

#### é‚Šç•Œå±¤çš„å‹åˆ¥è½‰æ›
```
å¤–å±¤ï¼ˆClientï¼‰     â†’ å¼·å‹åˆ¥åŒ…è£ï¼ˆSendableï¼‰
      â†“
ä¸­é–“å±¤ï¼ˆRepositoryï¼‰â†’ è§£åŒ…/è½‰æ›
      â†“
å…§å±¤ï¼ˆAPI/Networkï¼‰â†’ åŸå§‹å‹åˆ¥ï¼ˆJSON ç›¸å®¹ï¼‰
```

**åŸå‰‡**:
- åœ¨é‚Šç•Œè™•é€²è¡Œå‹åˆ¥è½‰æ›
- å¤–å±¤ä½¿ç”¨å¼·å‹åˆ¥ä¿è­‰å®‰å…¨
- å…§å±¤ä½¿ç”¨åŸå§‹å‹åˆ¥ä¿è­‰ç›¸å®¹

#### Protocol å°å‘è¨­è¨ˆ
```swift
// âœ… å„ªç§€ï¼šProtocol + å…·é«”å¯¦ä½œ
public protocol ClientProtocol: Sendable {
    func method() async throws -> Data
}

public struct Client: ClientProtocol {
    func method() async throws -> Data { ... }
}

// ä½¿ç”¨æ™‚ä¾è³´ Protocol
func useClient(_ client: ClientProtocol) { ... }
```

**å„ªé»**:
- ä¾è³´æ³¨å…¥å®¹æ˜“
- æ¸¬è©¦ mock å®¹æ˜“
- è§£è€¦åˆ

---

### 5. å·¥å…·å’Œè‡ªå‹•åŒ–

#### Cursor Commands è¨­è¨ˆ
```markdown
å¥½çš„ Command æ‡‰è©²åŒ…å«ï¼š
1. æ¸…æ¥šçš„ä½¿ç”¨æ–¹å¼
2. å…·é«”çš„åŸ·è¡Œæ­¥é©Ÿ
3. è¼¸å‡ºæ ¼å¼å®šç¾©
4. ä½¿ç”¨ç¯„ä¾‹
5. ç›¸é—œæ–‡ä»¶é€£çµ
```

**ä»Šå¤©å„ªåŒ–çš„ Command**:
- `check-tdd-consistency.md`
  - æ–°å¢ TDD æ›´æ–°åŠŸèƒ½
  - æ–°å¢æ›´æ–°åŸå‰‡
  - æ–°å¢è¼¸å‡ºæ–‡ä»¶èªªæ˜

---

## ğŸš€ æ”¹é€²å»ºè­°

### 1. æ¸¬è©¦è‡ªå‹•åŒ–ï¼ˆå„ªå…ˆç´šï¼šP0ï¼‰

**ç¾ç‹€**: 
- Client Layer æ¸¬è©¦è¦†è“‹ç‡ 0%
- æ‰‹å‹•æ¸¬è©¦ä¸è¶³

**å»ºè­°**:
```swift
// ç‚ºæ¯å€‹ Client æ·»åŠ å–®å…ƒæ¸¬è©¦
class PrematchCommentClientTests: XCTestCase {
    func testPublishComment_withSharedBets() async throws {
        let meta = SharedBetsMetadata(["betId": "123"])
        // ... test implementation
    }
}
```

**ç›®æ¨™**: 
- ä¸‹é€±å®Œæˆ Client Layer Unit Test
- è¦†è“‹ç‡ â‰¥ 80%

---

### 2. API è¦æ ¼é©—è­‰ï¼ˆå„ªå…ˆç´šï¼šP1ï¼‰

**ç¾ç‹€**:
- WebSocket é€£ç·šåƒæ•¸æœªèˆ‡å¾Œç«¯é©—è­‰
- STOMP è¨Šæ¯æ ¼å¼æœªç¢ºèª

**å»ºè­°**:
```swift
// Integration Test
class ChatWebSocketIntegrationTests: XCTestCase {
    func testWebSocketConnection() async throws {
        let client = ChatWebSocketClient(...)
        try await client.connect()
        // é©—è­‰é€£ç·šåƒæ•¸ã€è¨Šæ¯æ ¼å¼
    }
}
```

---

### 3. æ–‡ä»¶è‡ªå‹•åŒ–ï¼ˆå„ªå…ˆç´šï¼šP2ï¼‰

**ç¾ç‹€**:
- TDD æ–‡ä»¶éœ€æ‰‹å‹•æ›´æ–°
- å®¹æ˜“éºæ¼æˆ–ä¸ä¸€è‡´

**å»ºè­°**:
è€ƒæ…®è…³æœ¬è‡ªå‹•åŒ–ï¼š
1. æƒæ git diff è­˜åˆ¥å‹åˆ¥è®Šæ›´
2. è‡ªå‹•æ›´æ–° TDD æ–‡ä»¶ç¨‹å¼ç¢¼ç¯„ä¾‹
3. ç”Ÿæˆè®Šæ›´è¨˜éŒ„è‰ç¨¿

---

### 4. è¨­è¨ˆæ–‡æª”æ¨¡æ¿åŒ–ï¼ˆå„ªå…ˆç´šï¼šP2ï¼‰

**ç¾ç‹€**:
- è¨­è¨ˆæ±ºç­–è¨˜éŒ„æ ¼å¼ä¸çµ±ä¸€

**å»ºè­°**:
å‰µå»ºæ¨™æº–æ¨¡æ¿ï¼š
```markdown
# è¨­è¨ˆæ±ºç­–è¨˜éŒ„: [æ¨™é¡Œ]

## èƒŒæ™¯
[å•é¡Œæè¿°]

## æ±ºç­–
[è§£æ±ºæ–¹æ¡ˆ]

## ç†ç”±
[ç‚ºä½•é¸æ“‡]

## å½±éŸ¿
- å„ªé»: ...
- é™åˆ¶: ...
- Breaking Changes: ...

## æ›¿ä»£æ–¹æ¡ˆ
[è€ƒæ…®éçš„å…¶ä»–æ–¹æ¡ˆ]
```

---

### 5. CI/CD æ•´åˆï¼ˆå„ªå…ˆç´šï¼šP3ï¼‰

**å»ºè­°**:
- åœ¨ CI ä¸­é‹è¡Œ TDD ä¸€è‡´æ€§æª¢æŸ¥
- è‡ªå‹•ç”Ÿæˆæª¢æŸ¥å ±å‘Š
- PR æ™‚é¡¯ç¤ºè¦†è“‹ç‡è®ŠåŒ–

---

## ğŸ“ˆ é€²åº¦è¿½è¹¤

### æœ¬é€±ç›®æ¨™é”æˆåº¦
```
âœ… Data Layer é‡æ§‹              100%
âœ… TDD æ–‡ä»¶åŒæ­¥                 100%
âš ï¸ æ¸¬è©¦è£œå……                     0%   â† ä¸‹é€±é‡é»
âš ï¸ API é©—è­‰                     0%   â† ä¸‹é€±é‡é»
```

### ä¸‹é€±è¨ˆç•«
```
Week Focus: Repository Layer + Testing

Mon-Tue: Repository Layer å¯¦ä½œ
Wed-Thu: Client Layer æ¸¬è©¦è£œå……
Fri:     API æ•´åˆé©—è­‰èˆ‡é€±å ±
```

---

## ğŸ“ æŠ€è¡“æ·±åº¦å­¸ç¿’

### Swift Concurrency å­¸ç¿’è³‡æº

**ä»Šå¤©æ·±å…¥ç†è§£çš„æ¦‚å¿µ**:
1. `@unchecked Sendable` çš„ä½¿ç”¨å ´æ™¯
2. Actor isolation èˆ‡ nonisolated çš„å–æ¨
3. AsyncStream çš„æ­£ç¢ºå‰µå»ºæ¨¡å¼

**æ¨è–¦é–±è®€**:
- SE-0302: Sendable and @Sendable closures
- SE-0306: Actors
- WWDC 2021: Protect mutable state with Swift actors

---

### Clean Architecture å¯¦è¸

**ä»Šå¤©çš„å¯¦è¸**:
```
Presentation Layer
       â†“
Feature Layer (TCA)
       â†“
UseCase Layer (Business Logic)
       â†“
Repository Layer (Data Abstraction)
       â†“
Client Layer (HTTP/WebSocket)  â† ä»Šå¤©é‡æ§‹çš„å±¤ç´š
       â†“
API Layer (Endpoint Definition)
       â†“
Network Layer
```

**å­¸åˆ°çš„**:
- é‚Šç•Œå±¤çš„å‹åˆ¥è½‰æ›ç­–ç•¥
- Protocol å°å‘çš„ä¾è³´æ³¨å…¥
- é—œæ³¨é»åˆ†é›¢çš„é‡è¦æ€§

---

## ğŸ¤ å”ä½œèˆ‡æºé€š

### èˆ‡ Cursor AI çš„å”ä½œæ¨¡å¼

**æœ‰æ•ˆçš„å”ä½œæ–¹å¼**:
1. âœ… æä¾›æ¸…æ™°çš„ä¸Šä¸‹æ–‡ï¼ˆæª”æ¡ˆã€éœ€æ±‚ï¼‰
2. âœ… ä½¿ç”¨çµæ§‹åŒ–çš„ Command
3. âœ… åˆ†éšæ®µé©—è­‰çµæœ
4. âœ… ä¸»å‹•å›é¥‹å’Œèª¿æ•´

**ä»Šå¤©çš„å”ä½œæµç¨‹**:
```
éœ€æ±‚ â†’ Cursor åˆ†æ â†’ æ–¹æ¡ˆå»ºè­° â†’ 
ç”¨æˆ¶ç¢ºèª â†’ å¯¦ä½œ â†’ é©—è­‰ â†’ 
æ–‡ä»¶æ›´æ–° â†’ çµ±æ•´å­¸ç¿’
```

---

## ğŸ“š å€¼å¾—è¨˜éŒ„çš„ Code Snippets

### 1. SharedBetsMetadata åŒ…è£æ¨¡å¼

```swift
// å®šç¾©åŒ…è£å‹åˆ¥
public struct SharedBetsMetadata: @unchecked Sendable {
    public let value: [String: Any]
    
    public init(_ value: [String: Any]) {
        self.value = value
    }
}

// Client å±¤ä½¿ç”¨
let meta = SharedBetsMetadata(["betId": "123"])
try await client.publishComment(..., sharedBetsMeta: meta, ...)

// Repository å±¤è§£åŒ…
func publishComment(..., sharedBetsMeta: SharedBetsMetadata?, ...) {
    let metaDict: [String: Any]? = sharedBetsMeta?.value
    let endpoint = Endpoint.publishComment(..., sharedBetsMeta: metaDict, ...)
}
```

### 2. Nonisolated AsyncStream æ¨¡å¼

```swift
public actor MyActor {
    // Nonisolated æ–¹æ³•åŒæ­¥å‰µå»º stream
    public nonisolated func subscribe(id: String) -> AsyncStream<Message> {
        AsyncStream { continuation in
            Task {
                await self.performSubscribe(id: id, continuation: continuation)
            }
        }
    }
    
    // Actor-isolated å¯¦éš›é‚è¼¯
    private func performSubscribe(id: String, continuation: AsyncStream<Message>.Continuation) {
        // è¨‚é–±é‚è¼¯...
        continuation.yield(message)
    }
}
```

---

## ğŸ’­ åæ€èˆ‡ç¸½çµ

### ä»Šå¤©åšå¾—å¥½çš„åœ°æ–¹
1. âœ… ç³»çµ±æ€§åœ°è§£æ±º Sendable å•é¡Œ
2. âœ… å®Œæ•´è¨˜éŒ„è¨­è¨ˆæ±ºç­–
3. âœ… ä¸»å‹•æ›´æ–° TDD æ–‡ä»¶ä¿æŒåŒæ­¥
4. âœ… Commit æ‹†åˆ†æ¸…æ™°åˆç†

### å¯ä»¥æ”¹é€²çš„åœ°æ–¹
1. âš ï¸ æ¸¬è©¦æ‡‰è©²èˆ‡å¯¦ä½œåŒæ­¥å®Œæˆ
2. âš ï¸ API é©—è­‰æ‡‰è©²æ›´æ—©é€²è¡Œ
3. âš ï¸ å¯ä»¥æ›´æ—©èˆ‡å¾Œç«¯ç¢ºèªè¦æ ¼

### æ˜å¤©çš„é‡é»
1. é–‹å§‹ Repository Layer å¯¦ä½œ
2. è£œå…… Client Layer æ¸¬è©¦
3. è¦åŠƒ Domain Model Layer

---

## ğŸ”— ç›¸é—œè³‡æº

- **Branch**: feature/FOOTBALL-9180-9184-DataLayer
- **Commits**: 41c38d3, 1f97afa, 163d376, c00431a
- **TDD Reports**:
  - `tdd_consistency_check_2025-12-05.md`
  - `tdd_updates_2025-12-05.md`
- **Changelog**: `14_Changelog/CHANGELOG.md`

---

---

## ğŸ–¥ï¸ Cursor iOS é–‹ç™¼ç’°å¢ƒè¨­ç½®ï¼ˆä¸‹åˆæ™‚æ®µï¼‰

### ç’°å¢ƒè¨­ç½®ç›®æ¨™
å»ºç«‹å®Œæ•´çš„ Cursor iOS é–‹ç™¼ç’°å¢ƒï¼Œå¯¦ç¾åœ¨ Cursor ä¸­ç›´æ¥æ§‹å»ºã€é‹è¡Œå’Œèª¿è©¦ iOS appï¼Œç„¡éœ€åˆ‡æ›åˆ° Xcodeã€‚

---

### æ±ºç­– 6: Cursor iOS é–‹ç™¼å·¥å…·éˆé…ç½®

**èƒŒæ™¯**:
- éœ€è¦åœ¨ Cursor ä¸­å¯¦ç¾å®Œæ•´çš„ iOS é–‹ç™¼å·¥ä½œæµ
- åƒè€ƒ Thomas Ricouard çš„ Cursor iOS é–‹ç™¼å¯¦è¸
- ä½¿ç”¨ SweetPad + Xcode Build Server æ•´åˆ

**å®‰è£çš„å·¥å…·**:

1. **Homebrew å·¥å…·**:
   ```bash
   brew install xcode-build-server  # v1.2.0
   brew install xcbeautify           # v3.1.1  
   brew install swiftformat          # v0.58.7
   ```

2. **Cursor Extensions**:
   - `sswg.swift-lang` (v1.11.4) - Swift èªè¨€æ”¯æ´
   - `vadimcn.vscode-lldb` (v1.12.0) - LLDB èª¿è©¦å™¨
   - `SweetPad` - iOS/Swift é–‹ç™¼æ ¸å¿ƒæ’ä»¶

3. **é…ç½®æ–‡ä»¶**:
   - `.cursor/launch.json` - èª¿è©¦é…ç½®
   - `buildServer.json` - Xcode Build Server é…ç½®

**é…ç½®å…§å®¹**:

```json
// .cursor/launch.json
{
  "version": "0.2.0",
  "configurations": [{
    "type": "sweetpad-lldb",
    "request": "launch",
    "name": "Attach to running app (SweetPad)",
    "preLaunchTask": "sweetpad: launch"
  }]
}

// buildServer.json
{
  "name": "FCom",
  "uri": "file:///Users/reedhsin/Documents/codebase/fcom-iOS",
  "project": "FCom.xcodeproj",
  "scheme": "FCom"
}
```

---

### æ±ºç­– 7: xcode-select é…ç½®ä¿®å¾©

**å•é¡Œ**:
```
xcode-select: error: tool 'xcodebuild' requires Xcode, 
but active developer directory '/Library/Developer/CommandLineTools' 
is a command line tools instance
```

**åŸå› **:
ç³»çµ±æŒ‡å‘ Command Line Tools è€Œéå®Œæ•´çš„ Xcode

**è§£æ±ºæ–¹æ¡ˆ**:
```bash
# åˆ‡æ›åˆ°å®Œæ•´çš„ Xcode
sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer

# é©—è­‰
xcode-select -p
xcodebuild -version
```

**çµæœ**:
- Xcode 16.1 (Build 16B40) æ­£ç¢ºé…ç½®
- SweetPad å¯ä»¥æ­£å¸¸æ§‹å»ºå°ˆæ¡ˆ

---

### æ±ºç­– 8: SourceKit-LSP ç´¢å¼•å•é¡Œè™•ç†

**å•é¡Œ**:
- `ChatAPI+WebSocket.swift` å ±éŒ¯ "Cannot find type 'ChatAPI' in scope"
- ä½† `ChatAPI.swift` æ–‡ä»¶å­˜åœ¨ä¸”å…¶ä»– extension æ–‡ä»¶æ­£å¸¸

**åˆ†æ**:
- æ–‡ä»¶çµæ§‹æ­£ç¢ºï¼Œæ‰€æœ‰ extension åœ¨åŒä¸€ç›®éŒ„
- å…¶ä»– extension æ–‡ä»¶ï¼ˆå¦‚ `ChatAPI+Endpoint.swift`ï¼‰ä½¿ç”¨ç›¸åŒæ¨¡å¼ç„¡éŒ¯èª¤
- é€™æ˜¯ SourceKit-LSP ç´¢å¼•çš„æš«æ™‚æ€§å•é¡Œ

**è§£æ±ºæ­¥é©Ÿ**:
```bash
# 1. æ¸…ç†ç·©å­˜
rm -rf ~/Library/Caches/com.apple.dt.Xcode

# 2. é‡å•Ÿ SourceKit-LSP
killall sourcekit-lsp

# 3. é‡æ–°ç”Ÿæˆ buildServer.json
xcode-build-server config -workspace FCom.xcodeproj/project.xcworkspace -scheme FCom

# 4. é‡å•Ÿ Cursor
```

**å­¸ç¿’é»**:
- SourceKit ç´¢å¼•éŒ¯èª¤ä¸ä¸€å®šä»£è¡¨ä»£ç¢¼æœ‰å•é¡Œ
- æ¸…ç†ç·©å­˜å’Œé‡å•Ÿæ˜¯å¸¸è¦‹è§£æ±ºæ–¹æ¡ˆ
- å¯¦éš›æ§‹å»ºæˆåŠŸæ‰æ˜¯çœŸæ­£çš„é©—è­‰

---

### æˆåŠŸæ§‹å»ºé©—è­‰

**ç¬¬ä¸€æ¬¡æ§‹å»º**:
- Target: FCom
- Destination: iPhone 16 Plus, OS=18.1
- çµæœ: âœ… Build Succeeded

**æ§‹å»ºè¼¸å‡º**:
```
âœ… Swift Package ä¾è³´è§£æå®Œæˆ
âœ… ç·¨è­¯å®Œæˆ
âœ… æ¨¡æ“¬å™¨å•Ÿå‹•: xcrun simctl boot 581BF0ED...
âœ… App å®‰è£: xcrun simctl install ... FCom.app
âœ… App å•Ÿå‹•: xcrun simctl launch ... com.sportybet.SportyBet
âœ… Firebase åˆå§‹åŒ–: Version 10.29.0
```

**Warnings åˆ†æ**:
- 81 å€‹ linter warningsï¼Œä¸»è¦é¡å‹ï¼š
  - ~50% æ£„ç”¨çš„ API (iOS 15 UIButton APIs)
  - ~20% Swift 6 ä¸¦ç™¼è­¦å‘Š
  - ~20% æœªä½¿ç”¨çš„è®Šæ•¸
  - ~10% å…¶ä»–
- é€™äº›æ˜¯è­¦å‘Šä¸æ˜¯éŒ¯èª¤ï¼Œä¸å½±éŸ¿é‹è¡Œ
- å¯ä»¥é€æ­¥ä¿®å¾©ï¼Œä¸ç·Šæ€¥

---

### SweetPad å·¥ä½œæµç¨‹å­¸ç¿’

**åŸºæœ¬æ“ä½œ**:

1. **æ§‹å»ºä¸¦é‹è¡Œ**:
   - Command Palette â†’ `Sweetpad: Build & Run (Launch)`
   - é¸æ“‡ Target: `FCom`
   - é¸æ“‡ Destination: iPhone æ¨¡æ“¬å™¨

2. **æ¸…ç†æ§‹å»º**:
   - `Sweetpad: Clean` â†’ æ¸…ç†æ§‹å»ºç”¢ç‰©
   - æˆ–æ‰‹å‹•: `rm -rf ~/Library/Developer/Xcode/DerivedData/FCom-*`

3. **èª¿è©¦**:
   - F5 é–‹å§‹èª¿è©¦
   - ä½¿ç”¨ SweetPad LLDB é…ç½®
   - æ”¯æ´æ–·é»å’Œèª¿ç”¨å †ç–Š

**æª¢æŸ¥æ§‹å»ºç‹€æ…‹**:

```bash
# æª¢æŸ¥æ§‹å»ºé€²ç¨‹
ps aux | grep xcodebuild

# æª¢æŸ¥æ¨¡æ“¬å™¨ç‹€æ…‹  
xcrun simctl list devices | grep Booted

# æª¢æŸ¥ App æ˜¯å¦é‹è¡Œ
xcrun simctl spawn booted ps aux | grep FCom
```

---

### çµ‚ç«¯æ©Ÿå•é¡Œè™•ç†

**å•é¡Œ**: Cursor çµ‚ç«¯æ©Ÿé¡¯ç¤ºç©ºç™½

**è§£æ±ºæ–¹æ¡ˆ**:
```bash
# æ–¹æ³• 1: é‡æ–°å•Ÿå‹• shell
exec zsh

# æ–¹æ³• 2: å‰µå»ºæ–°çµ‚ç«¯æ©Ÿ
Ctrl+Shift+` (åå¼•è™Ÿ)

# æ–¹æ³• 3: é‡æ–°è¼‰å…¥è¦–çª—
Cmd+Shift+P â†’ Developer: Reload Window
```

**é©—è­‰**: 
çµ‚ç«¯æ©Ÿæ­£å¸¸é¡¯ç¤ºæç¤ºç¬¦ï¼š`reedhsin@ReeddeMacBook-Pro fcom-iOS %`

---

### å‰µå»ºçš„æ–‡æª”

1. **CURSOR_IOS_SETUP.md** - å®Œæ•´è¨­ç½®æŒ‡å—
   - å·¥å…·å®‰è£æ­¥é©Ÿ
   - é…ç½®èªªæ˜
   - é©—è­‰æ¸…å–®
   - æ•…éšœæ’é™¤

2. **CURSOR_IOS_SETUP_PROMPT.md** - AI Prompt ç‰ˆæœ¬
   - å¯ç›´æ¥è¤‡è£½çµ¦ Cursor AI
   - è‡ªå‹•åŸ·è¡Œè¨­ç½®æ­¥é©Ÿ

3. **SWEETPAD_BUILD_RUN.md** - SweetPad ä½¿ç”¨æŒ‡å—
   - ä¸‰ç¨®æ§‹å»ºæ–¹æ³•
   - å¸¸ç”¨å‘½ä»¤åƒè€ƒ
   - æ•…éšœæ’é™¤

4. **FIX_XCODE_SELECT.md** - xcode-select ä¿®å¾©æŒ‡å—
   - éŒ¯èª¤è¨ºæ–·
   - ä¿®å¾©è…³æœ¬
   - é©—è­‰æ­¥é©Ÿ

5. **CHECK_SWEETPAD_STATUS.md** - ç‹€æ…‹æª¢æŸ¥æŒ‡å—
   - å¤šç¨®æª¢æŸ¥æ–¹æ³•
   - å¯¦æ™‚ç›£æ§è…³æœ¬
   - å¿«é€Ÿåƒè€ƒå‘½ä»¤

6. **FIX_TERMINAL_BLANK.md** - çµ‚ç«¯æ©Ÿä¿®å¾©æŒ‡å—
   - å¸¸è¦‹å•é¡Œ
   - å¤šç¨®è§£æ±ºæ–¹æ¡ˆ

---

### å­¸ç¿’è¦é»

**1. Cursor + Xcode æ•´åˆæ¶æ§‹**:
```
Cursor IDE
    â†“
SweetPad Extension
    â†“
Xcode Build Server (xcode-build-server)
    â†“
xcodebuild CLI
    â†“
xcbeautify (è¼¸å‡ºç¾åŒ–)
    â†“
Simulator/Device
```

**2. å•é¡Œè¨ºæ–·æµç¨‹**:
```
1. æª¢æŸ¥å·¥å…·æ˜¯å¦å®‰è£ï¼ˆbrew listï¼‰
2. æª¢æŸ¥é…ç½®æ–‡ä»¶ï¼ˆbuildServer.json, launch.jsonï¼‰
3. æª¢æŸ¥ xcode-select é…ç½®
4. æª¢æŸ¥ SourceKit ç´¢å¼•ç‹€æ…‹
5. æŸ¥çœ‹çµ‚ç«¯æ©Ÿè¼¸å‡º
6. æª¢æŸ¥ Problems é¢æ¿
```

**3. æœ€ä½³å¯¦è¸**:
- é‡åˆ°éŒ¯èª¤å…ˆçœ‹çµ‚ç«¯æ©Ÿè¼¸å‡º
- SourceKit éŒ¯èª¤ä¸ä¸€å®šæ˜¯çœŸéŒ¯èª¤
- æ¸…ç†ç·©å­˜æ˜¯è¬èƒ½è§£æ±ºæ–¹æ¡ˆ
- é©—è­‰æ§‹å»ºæˆåŠŸæ‰æ˜¯ç‹é“
- è¨˜éŒ„è¨­ç½®æ­¥é©Ÿæ–¹ä¾¿åˆ†äº«

**4. åƒè€ƒè³‡æº**:
- [Cursor å®˜æ–¹ Swift é–‹ç™¼æŒ‡å—](https://docs.cursor.com/zh-Hant/guides/languages/swift)
- [Thomas Ricouard çš„ Cursor iOS é–‹ç™¼å¯¦æˆ°æŒ‡å—](https://dimillian.medium.com/how-to-use-cursor-for-ios-development-54b912c23941)

---

### ç’°å¢ƒè¨­ç½®æˆæœ

âœ… **å®Œæˆçš„é…ç½®**:
- Homebrew å·¥å…·å®‰è£å®Œæˆï¼ˆ3å€‹ï¼‰
- Cursor Extensions å®‰è£å®Œæˆï¼ˆ3å€‹ï¼‰
- é…ç½®æ–‡ä»¶å‰µå»ºå®Œæˆï¼ˆ2å€‹ï¼‰
- xcode-select æ­£ç¢ºé…ç½®
- é¦–æ¬¡æ§‹å»ºæˆåŠŸ
- App åœ¨æ¨¡æ“¬å™¨ä¸Šé‹è¡Œ

âœ… **å‰µå»ºçš„æ–‡æª”**:
- 6 ä»½å®Œæ•´çš„è¨­ç½®å’Œä½¿ç”¨æŒ‡å—
- å¯åˆ†äº«çµ¦å…¶ä»–é–‹ç™¼è€…ä½¿ç”¨

âœ… **é©—è­‰çš„åŠŸèƒ½**:
- æ§‹å»ºå°ˆæ¡ˆ
- é‹è¡Œåœ¨æ¨¡æ“¬å™¨
- çµ‚ç«¯æ©Ÿè¼¸å‡º
- å•é¡Œè¨ºæ–·
- ç‹€æ…‹æª¢æŸ¥

**ä¸‹ä¸€æ­¥**:
- å­¸ç¿’æ›´å¤š SweetPad é«˜ç´šåŠŸèƒ½
- é…ç½®è‡ªå®šç¾©å¿«æ·éµ
- æ¢ç´¢èª¿è©¦åŠŸèƒ½
- æ•´åˆå…¶ä»–é–‹ç™¼å·¥å…·

---

---

## ğŸ”§ Swift ä¸¦ç™¼å•é¡Œä¿®å¾©ï¼ˆæ™šé–“æ™‚æ®µï¼‰

### æ±ºç­– 9: xcode-build-server é‡æ–°å®‰è£

**å•é¡Œ**:
- éœ€è¦ç¢ºä¿ xcode-build-server æ­£ç¢ºå®‰è£
- ç‚ºæ¯å€‹ Swift Package ç”Ÿæˆç¨ç«‹çš„ buildServer.json

**åŸ·è¡Œ**:
```bash
# é‡æ–°å®‰è£ xcode-build-server
brew uninstall xcode-build-server
brew install xcode-build-server  # v1.2.0

# ç‚ºä¸»é …ç›®ç”Ÿæˆé…ç½®
cd /Users/reedhsin/Documents/codebase/fcom-iOS
xcode-build-server config -project FCom.xcodeproj -scheme FCom

# ç‚º MatchChat ç”Ÿæˆç¨ç«‹é…ç½®
cd MatchChat
xcode-build-server config -project ../FCom.xcodeproj -scheme MatchChat
```

**å­¸ç¿’é»**:
- ä¸€å€‹ workspace çš„ buildServer.json å°±è¶³å¤ 
- å­ç›®éŒ„çš„ buildServer.json å¯æ”¹å–„ LSP é«”é©—
- ä½†éœ€è¦å…ˆæˆåŠŸç·¨è­¯æ‰èƒ½ç”Ÿæˆ

---

### æ±ºç­– 10: ä¿®å¾© Swift 6 Concurrency éŒ¯èª¤

**èƒŒæ™¯**:
MatchChat ä½¿ç”¨ Swift 6.0ï¼Œå•Ÿç”¨åš´æ ¼ä¸¦ç™¼æª¢æŸ¥ï¼Œå°è‡´å…©å€‹ç·¨è­¯éŒ¯èª¤ï¼š

1. **`PrematchCommentAPI+Repository.swift:42`**:
   ```
   error: non-sendable type '[String : Any]?' in parameter 
   cannot cross actor boundary
   ```

2. **`ChatWebSocketClient.swift:178`**:
   ```
   error: actor-isolated instance method 'subscribe(chatroomId:)' 
   cannot be used to satisfy nonisolated protocol requirement
   ```

**è§£æ±ºæ–¹æ¡ˆ 1: SharedBetsMetadata Wrapperï¼ˆæœ€çµ‚ç‰ˆæœ¬ï¼‰**

```swift
// å®šç¾© Sendable wrapper
public struct SharedBetsMetadata: @unchecked Sendable {
    public let value: [String: Any]
    
    public init(_ value: [String: Any]) {
        self.value = value
    }
}

// æ›´æ–°æ‰€æœ‰å±¤ç´šçš„ç°½å
// Protocol
func publishComment(..., sharedBetsMeta: SharedBetsMetadata?, ...)

// Repository  
func publishComment(..., sharedBetsMeta: SharedBetsMetadata?, ...) {
    let metaDict: [String: Any]? = sharedBetsMeta?.value
    let endpoint = Endpoint.publishComment(..., sharedBetsMeta: metaDict, ...)
}

// Endpoint (ä¿æŒåŸæ¨£)
case publishComment(..., sharedBetsMeta: [String: Any]?, ...)
```

**è¨­è¨ˆè€ƒé‡**:
- âœ… ç¬¦åˆ TDD å®šç¾©ï¼š`[String: AnyCodable]?` çš„èªæ„
- âœ… Response çš„ `sharedBetsMeta: String?` ä¿æŒä¸è®Š
- âœ… æ”¯æ´ä»»æ„ JSON çµæ§‹
- âš ï¸ ä½¿ç”¨ `@unchecked Sendable`ï¼ˆéœ€é–‹ç™¼è€…ç¢ºä¿ç·šç¨‹å®‰å…¨ï¼‰

**è§£æ±ºæ–¹æ¡ˆ 2: ChatWebSocketClient.subscribe Nonisolated**

```swift
// å°‡ subscribe æ¨™è¨˜ç‚º nonisolated
public actor ChatWebSocketClient {
    public nonisolated func subscribe(chatroomId: String) 
        -> AsyncStream<ChatAPI.WebSocketMessageDTO> {
        AsyncStream { continuation in
            Task {
                await self.performSubscribe(
                    chatroomId: chatroomId,
                    continuation: continuation
                )
            }
        }
    }
    
    // Actor-isolated å¯¦éš›é‚è¼¯
    private func performSubscribe(
        chatroomId: String,
        continuation: AsyncStream<...>.Continuation
    ) {
        // è¨‚é–±é‚è¼¯...
    }
}

// ChatroomSubscription ä¹Ÿéœ€èª¿æ•´
private class ChatroomSubscription {
    func addSubscriber(id: UUID, continuation: AsyncStream<...>.Continuation) {
        continuationsLock.lock()
        defer { continuationsLock.unlock() }
        messageContinuations[id] = continuation
    }
}
```

**æ”¹é€²åŸç†**:
1. `nonisolated` æ–¹æ³•åŒæ­¥å‰µå»º `AsyncStream`
2. å¯¦éš›è¨‚é–±é‚è¼¯åœ¨ `Task` ä¸­ç•°æ­¥åŸ·è¡Œ
3. Protocol ä¹Ÿæ¨™è¨˜ç‚º `nonisolated`
4. æ”¹å–„ API æ˜“ç”¨æ€§ï¼Œç„¡éœ€ `await`

---

### æ±ºç­– 11: TDD æ–‡ä»¶ä¸€è‡´æ€§æª¢æŸ¥èˆ‡ä¿®æ­£

**å•é¡Œç™¼ç¾**:
ç”¨æˆ¶è©¢å•ï¼šã€Œé€™å€‹ä¿®å¾©æœ‰èˆ‡ TDDs æ–‡ä»¶å®šç¾©ä¸€è‡´å—ï¼Ÿã€

**æª¢æŸ¥çµæœ**:
- TDD å®šç¾©ï¼ˆç¬¬ 294 è¡Œï¼‰ï¼š`sharedBetsMeta: [String: AnyCodable]?`
- Response DTOï¼ˆç¬¬ 162 è¡Œï¼‰ï¼š`sharedBetsMeta: String?`

**ä¸ä¸€è‡´ä¹‹è™•**:
- TDD ä¸­ Request å’Œ Response çš„å‹åˆ¥å®šç¾©ä¸ä¸€è‡´
- Request æ˜¯ Dictionaryï¼ŒResponse æ˜¯ String

**ä¿®æ­£æ–¹æ¡ˆ**:
æœ€çµ‚æ¡ç”¨ `SharedBetsMetadata` wrapperï¼Œå› ç‚ºï¼š
1. èªæ„ä¸Šç­‰åŒæ–¼ `[String: AnyCodable]?`
2. è§£æ±º Sendable å•é¡Œ
3. å‹åˆ¥æ›´æ˜ç¢º

**ä¸€è‡´æ€§ç¢ºèª**: âœ… 
- Request: `SharedBetsMetadata` å°è£ `[String: Any]`
- Response: `String?` (JSON string)
- ç¬¦åˆ API å¯¦éš›è¡Œç‚º

---

### æ±ºç­– 12: .gitignore æ›´æ–°

**èƒŒæ™¯**:
- `buildServer.json` æ˜¯æœ¬åœ°é…ç½®æ–‡ä»¶
- æ¯å€‹é–‹ç™¼è€…ç’°å¢ƒä¸åŒ
- åœ¨ git æ“ä½œä¸­æœƒé€ æˆè¡çª

**æ±ºç­–**:
```bash
# åŠ å…¥ .gitignore
echo "buildServer.json" >> .gitignore

# åˆªé™¤å·²è¿½è¹¤çš„æ–‡ä»¶
git rm --cached buildServer.json
git rm --cached MatchChat/buildServer.json
```

**åŸå› **:
- `buildServer.json` åŒ…å«æœ¬åœ°è·¯å¾‘ï¼ˆDerivedDataï¼‰
- é¡ä¼¼ `.vscode/settings.json` çš„æ€§è³ª
- æ‡‰è©²æ˜¯æ¯å€‹é–‹ç™¼è€…è‡ªå·±ç”Ÿæˆ

---

### ç·¨è­¯é©—è­‰

**ç¬¬ä¸€æ¬¡å˜—è©¦**: âŒ 
```
error: non-sendable type '[String : Any]?' in parameter
```

**ç¬¬äºŒæ¬¡å˜—è©¦**: âŒ
```
error: cannot convert value of type '[String : Any]?' 
to expected argument type '[String : String]?'
```

**å•é¡Œè¨ºæ–·**:
- `search_replace` å·¥å…·çš„æ›´æ–°æœªç”Ÿæ•ˆ
- éœ€è¦ä½¿ç”¨ `sed` ç›´æ¥ä¿®æ”¹æ–‡ä»¶

**æœ€çµ‚ä¿®å¾©**:
```bash
sed -i '' 's/sharedBetsMeta: \[String: String\]/sharedBetsMeta: [String: Any]/g' \
  PrematchCommentAPI+Endpoint.swift
```

**æœ€çµ‚çµæœ**: âœ… **BUILD SUCCEEDED**

---

### æ›´æ–°çš„æ–‡ä»¶

**ä¿®æ”¹çš„æ–‡ä»¶**:
1. `PrematchCommentAPI+RepositoryProtocol.swift` - æ–°å¢ SharedBetsMetadata
2. `PrematchCommentAPI+Repository.swift` - ä½¿ç”¨ wrapper
3. `PrematchCommentAPI+Endpoint.swift` - ä¿æŒ `[String: Any]`
4. `PrematchCommentClient.swift` - ä½¿ç”¨ wrapper
5. `PrematchCommentClientProtocol.swift` - ä½¿ç”¨ wrapper
6. `ChatWebSocketClient.swift` - nonisolated subscribe
7. `ChatWebSocketClientProtocol.swift` - nonisolated subscribe
8. `.gitignore` - åŠ å…¥ buildServer.json

**æ–°å¢çš„æ–‡ä»¶**:
- `buildServer.json` (æ ¹ç›®éŒ„)
- `MatchChat/buildServer.json` (æ‰‹å‹•å‰µå»º)

---

### å­¸ç¿’è¦é»è£œå……

#### Swift 6 Strict Concurrency Mode

**å•Ÿç”¨æ–¹å¼**:
```swift
// Package.swift
// swift-tools-version: 6.0
```

**å½±éŸ¿**:
- åš´æ ¼æª¢æŸ¥ Sendable å”è­°
- Actor isolation è¦å‰‡
- è·¨ actor boundary çš„å‹åˆ¥å‚³é

**å¸¸è¦‹éŒ¯èª¤**:
1. Non-sendable type crossing actor boundary
2. Actor-isolated method satisfying nonisolated protocol
3. Data race detection

#### @unchecked Sendable ä½¿ç”¨æ™‚æ©Ÿ

**é©ç”¨å ´æ™¯**:
- âœ… åŒ…è£ Foundation å‹åˆ¥ï¼ˆå¦‚ Dictionaryï¼‰
- âœ… ç¢ºä¿å¯¦éš›ä½¿ç”¨æ˜¯ç·šç¨‹å®‰å…¨çš„
- âœ… ç„¡æ³•ä¿®æ”¹å‹åˆ¥æœ¬èº«æ™‚

**ä½¿ç”¨åŸå‰‡**:
- âš ï¸ è¬¹æ…ä½¿ç”¨ï¼Œéœ€ç¢ºä¿ç·šç¨‹å®‰å…¨
- âš ï¸ æ·»åŠ è¨»é‡‹èªªæ˜ç‚ºä½•å®‰å…¨
- âš ï¸ è€ƒæ…®æœªä¾†æ˜¯å¦æœ‰æ›´å¥½çš„æ–¹æ¡ˆ

#### å·¥å…·ä½¿ç”¨æŠ€å·§

**search_replace å·¥å…·é™åˆ¶**:
- æœ‰æ™‚æ›´æ–°ä¸æœƒç«‹å³ç”Ÿæ•ˆ
- å¯èƒ½æ˜¯ç·©å­˜æˆ–æ™‚åºå•é¡Œ
- å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ terminal `sed` å‘½ä»¤

**é©—è­‰æ–¹æ³•**:
```bash
# ç›´æ¥æª¢æŸ¥æ–‡ä»¶å…§å®¹
grep -n "pattern" file.swift

# æˆ–ä½¿ç”¨ cat
cat file.swift | grep "pattern"
```

---

### å•é¡Œæ’æŸ¥æµç¨‹

**ç·¨è­¯å¤±æ•—è¨ºæ–·æµç¨‹**:
```
1. çœ‹éŒ¯èª¤è¨Šæ¯æ‰¾å‡ºå…·é«”è¡Œæ•¸
   â†“
2. æª¢æŸ¥ç›¸é—œæ–‡ä»¶çš„å‹åˆ¥å®šç¾©
   â†“
3. ç¢ºèª Protocolã€å¯¦ä½œã€èª¿ç”¨æ–¹ä¸€è‡´æ€§
   â†“
4. é©—è­‰ä¿®æ”¹æ˜¯å¦çœŸçš„ç”Ÿæ•ˆï¼ˆgrep æª¢æŸ¥ï¼‰
   â†“
5. æ¸…ç†ç·¨è­¯ç·©å­˜å¾Œé‡è©¦
   â†“
6. é€æ­¥é©—è­‰æ¯å±¤çš„å‹åˆ¥åŒ¹é…
```

**æœ¬æ¬¡å¯¦éš›æµç¨‹**:
```
éŒ¯èª¤ 1: [String: Any]? ä¸æ˜¯ Sendable
  â†“
è§£æ±º: å‰µå»º SharedBetsMetadata wrapper
  â†“
éŒ¯èª¤ 2: [String: Any]? ç„¡æ³•è½‰æ›ç‚º [String: String]?
  â†“
æª¢æŸ¥: Endpoint å®šç¾©ä»æ˜¯èˆŠçš„
  â†“
è§£æ±º: ä½¿ç”¨ sed ç›´æ¥ä¿®æ”¹
  â†“
âœ… BUILD SUCCEEDED
```

---

### ä¸‹æ¬¡æ”¹é€²å»ºè­°

1. **å·¥å…·ä½¿ç”¨**:
   - search_replace å¾Œç«‹å³é©—è­‰
   - é‡è¦ä¿®æ”¹è€ƒæ…®å…ˆç”¨ sed
   - å»ºç«‹é©—è­‰è…³æœ¬

2. **å‹åˆ¥è¨­è¨ˆ**:
   - ææ—©è€ƒæ…® Sendable éœ€æ±‚
   - é‚Šç•Œå±¤å‹åˆ¥è½‰æ›ç­–ç•¥
   - Protocol è¨­è¨ˆè€ƒæ…®ä¸¦ç™¼

3. **æ¸¬è©¦è¦†è“‹**:
   - ä¸¦ç™¼å ´æ™¯çš„æ¸¬è©¦
   - Actor boundary æ¸¬è©¦
   - å‹åˆ¥å®‰å…¨æ¸¬è©¦

---

**çµ±æ•´å®Œæˆæ™‚é–“**: 2025-12-05 00:30  
**ä¸‹æ¬¡çµ±æ•´**: 2025-12-05 (ä»Šå¤©)

