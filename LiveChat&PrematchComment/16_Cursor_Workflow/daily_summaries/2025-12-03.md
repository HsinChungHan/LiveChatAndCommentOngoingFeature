# 2025-12-03 å°è©±çµ±æ•´

**æ—¥æœŸ**: 2025-12-03  
**ä¸»è¦å·¥ä½œ**: ChatWebSocketClient å¯¦ä½œèˆ‡ä¿®å¾©

---

## ğŸ“‹ é‡è¦æ±ºç­– / Key Decisions

### 1. æŠ€è¡“é¸å‹æ±ºç­–

#### ä½¿ç”¨ SportyStomp æ¡†æ¶
- **æ±ºç­–**: ä½¿ç”¨ `SportyStomp` å¯¦ä½œ `ChatWebSocketClient`
- **ç†ç”±**:
  - å°ˆæ¡ˆå·²æœ‰ SportyStomp æ¡†æ¶
  - å·²å¯¦ä½œå¿ƒè·³æ©Ÿåˆ¶ (`enableAutoPing()`)
  - å·²å¯¦ä½œ STOMP å”è­°æ”¯æ´
  - æœ‰å®Œæ•´çš„ delegate æ©Ÿåˆ¶
  - ä»£ç¢¼åº«ä¸­å·²æœ‰åƒè€ƒå¯¦ä½œ (`WebSocketStompManager`)
- **ä¾†æº**: TDD æ–‡ä»¶æ˜ç¢ºæŒ‡å®šï¼Œåƒè€ƒå¯¦ä½œå·²å­˜åœ¨

#### ä½¿ç”¨ actor è€Œé class
- **æ±ºç­–**: `ChatWebSocketClient` ä½¿ç”¨ `actor` è€Œé `class`
- **ç†ç”±**:
  - TDD æ–‡ä»¶è¦æ±‚ä½¿ç”¨ `actor`
  - `actor` æä¾›å…§å»ºçš„ç·šç¨‹å®‰å…¨ä¿è­‰
  - ç¬¦åˆç¾ä»£ Swift ä¸¦ç™¼æ¨¡å¼
- **å¯¦ä½œ**: âœ… å·²å¯¦ä½œ

#### ä½¿ç”¨ AsyncStream è€Œé callback
- **æ±ºç­–**: ä½¿ç”¨ `AsyncStream<ChatAPI.WebSocketMessageDTO>` æä¾›è¨Šæ¯æµ
- **ç†ç”±**:
  - ç¬¦åˆç¾ä»£ Swift ä¸¦ç™¼æ¨¡å¼
  - æ›´å®¹æ˜“èˆ‡ TCA æ•´åˆ
  - æ”¯æ´å¤šè¨‚é–±è€…æ¨¡å¼
  - æ›´å¥½çš„ç”Ÿå‘½é€±æœŸç®¡ç†
- **å¯¦ä½œ**: âœ… å·²å¯¦ä½œï¼Œåƒè€ƒ `EventOddsWebSocketManager` æ¨¡å¼

### 2. API èª¿ç”¨ä¿®æ­£æ±ºç­–

#### SportyStomp API åƒæ•¸ä¿®æ­£
- **å•é¡Œ**: åˆå§‹å¯¦ä½œä½¿ç”¨äº†éŒ¯èª¤çš„ API åƒæ•¸åç¨±
- **ä¿®æ­£**:
  - `SportyStomp(host:)` åƒæ•¸é¡å‹ï¼š`URL` è€Œé `String`
  - `subscribe(to:id:headers:)` è€Œé `subscribe(to:from:headers:)`
  - `unsubscribe(from:)` è€Œé `unsubscribe(id:)`
  - `send(body:to:headers:)` è€Œé `send(message:toDestination:withHeaders:)`
- **æ–¹æ³•**: ç›´æ¥æŸ¥çœ‹ `SportyStomp` æºç¢¼ç¢ºèªæ­£ç¢ºçš„ API ç°½å

### 3. ä¸¦ç™¼å®‰å…¨æ±ºç­–

#### è™•ç† nonisolated delegate æ–¹æ³•
- **æ±ºç­–**: ä½¿ç”¨ `nonisolated` + `Task` è™•ç† `SwiftStompDelegate` å›èª¿
- **å¯¦ä½œ**:
  - æ‰€æœ‰ delegate æ–¹æ³•æ¨™è¨˜ç‚º `public nonisolated`
  - åœ¨ `Task` é–‰åŒ…ä¸­èª¿ç”¨ actor æ–¹æ³•
  - ç§»é™¤ `@Sendable` æ¨™è¨˜ï¼ˆå€¼é¡å‹åœ¨ Task ä¸­å·²å®‰å…¨ï¼‰
- **å­¸ç¿’**: å€¼é¡å‹ï¼ˆenumã€Stringï¼‰åœ¨ `Task` é–‰åŒ…ä¸­è‡ªå‹•è¤‡è£½ï¼Œä¸éœ€è¦ `@Sendable`

#### è™•ç† Sendable è­¦å‘Š
- **æ±ºç­–**: ç‚ºå¤–éƒ¨åº«çš„ enum æ·»åŠ  `@unchecked @retroactive Sendable`
- **å¯¦ä½œ**:
  ```swift
  extension StompConnectType: @unchecked @retroactive Sendable {}
  extension StompDisconnectType: @unchecked @retroactive Sendable {}
  extension StompErrorType: @unchecked @retroactive Sendable {}
  ```
- **ç†ç”±**: é€™äº› enum æ˜¯å€¼é¡å‹ï¼Œå¯¦éš›ä¸Šæ˜¯ç·šç¨‹å®‰å…¨çš„ï¼Œä½†å¤–éƒ¨åº«æœªæ¨™è¨˜ç‚º `Sendable`

#### è™•ç† Any? é¡å‹è½‰æ›
- **æ±ºç­–**: åœ¨ delegate æ–¹æ³•ä¸­å°‡ `message: Any?` è½‰æ›ç‚º `String?`
- **å¯¦ä½œ**:
  ```swift
  let messageString = message as? String
  Task {
      await handleMessageReceived(message: messageString, destination: destination)
  }
  ```
- **ç†ç”±**: `String` æ˜¯å€¼é¡å‹ä¸” `Sendable`ï¼Œé¿å…æ•¸æ“šç«¶çˆ­è­¦å‘Š

### 4. æ–¹æ³•ç°½åæ”¹é€²æ±ºç­–

#### unsubscribe æ–¹æ³•è¨­è¨ˆ
- **TDD è¦æ±‚**: `unsubscribe(chatroomId: String)`
- **å¯¦éš›å¯¦ä½œ**: `unsubscribe(subscriberId: UUID)` + `unsubscribeAll(chatroomId: String)`
- **ç†ç”±**: 
  - æ”¯æ´å¤šè¨‚é–±è€…æ¨¡å¼ï¼Œéœ€è¦é€šé `subscriberId` ä¾†å–æ¶ˆç‰¹å®šè¨‚é–±
  - æä¾›äº† `unsubscribeAll()` ä½œç‚ºè£œå……ï¼Œå¯ä»¥å–æ¶ˆæ•´å€‹ chatroom çš„æ‰€æœ‰è¨‚é–±
- **è©•ä¼°**: âœ… å¯¦éš›å¯¦ä½œæ›´åˆç†ï¼Œç¬¦åˆå¤šè¨‚é–±è€…æ¨¡å¼éœ€æ±‚

---

## ğŸ“ å­¸ç¿’è¦é» / Key Learnings

### 1. Swift ä¸¦ç™¼ç›¸é—œ

#### å€¼é¡å‹åœ¨ Task ä¸­çš„è¡Œç‚º
- **å­¸ç¿’**: å€¼é¡å‹ï¼ˆenumã€Stringã€structï¼‰åœ¨ `Task` é–‰åŒ…ä¸­æœƒè‡ªå‹•è¤‡è£½
- **å¯¦ä½œå½±éŸ¿**: ä¸éœ€è¦ç‚ºå€¼é¡å‹æ·»åŠ  `@Sendable` æ¨™è¨˜æˆ–å‰µå»ºæœ¬åœ°å‰¯æœ¬
- **ç¯„ä¾‹**:
  ```swift
  // âŒ ä¸éœ€è¦é€™æ¨£åš
  let connectType = connectType
  Task { @Sendable in
      await handleConnect(connectType: connectType)
  }
  
  // âœ… ç›´æ¥ä½¿ç”¨å³å¯
  Task {
      await handleConnect(connectType: connectType)
  }
  ```

#### nonisolated æ–¹æ³•çš„ä½¿ç”¨
- **å­¸ç¿’**: `nonisolated` æ–¹æ³•å¯ä»¥å¾ä»»ä½•éš”é›¢åŸŸèª¿ç”¨ï¼Œä½†ä¸èƒ½ç›´æ¥è¨ªå• actor çš„éš”é›¢ç‹€æ…‹
- **å¯¦ä½œæ¨¡å¼**: 
  ```swift
  public nonisolated func onConnect(...) {
      Task {
          await handleConnect(...)  // é€šé Task é€²å…¥ actor éš”é›¢åŸŸ
      }
  }
  ```

#### @Sendable çš„ä½œç”¨
- **å­¸ç¿’**: `@Sendable` ä¸»è¦ç”¨æ–¼å¼•ç”¨é¡å‹ï¼Œç¢ºä¿å®ƒå€‘æ˜¯ç·šç¨‹å®‰å…¨çš„
- **å€¼é¡å‹**: å€¼é¡å‹åœ¨å‚³éæ™‚æœƒè‡ªå‹•è¤‡è£½ï¼Œä¸éœ€è¦ `@Sendable`
- **å¼•ç”¨é¡å‹**: å¼•ç”¨é¡å‹éœ€è¦ç¢ºä¿ç·šç¨‹å®‰å…¨ï¼Œæ‰éœ€è¦ `@Sendable`

### 2. SportyStomp API ä½¿ç”¨

#### API ç°½åç¢ºèªæ–¹æ³•
- **å­¸ç¿’**: ç›´æ¥æŸ¥çœ‹æºç¢¼æ˜¯æœ€å¯é çš„æ–¹æ³•
- **ä½ç½®**: `MatchChat/.build/checkouts/SportyStomp/Sources/SportyStomp/SportyStomp.swift`
- **é—œéµ API**:
  - `init(host: URL, headers: [String: String]?)`
  - `subscribe(to: String, id: String, mode: StompAckMode, headers: [String: String]?)`
  - `unsubscribe(from: String, mode: StompAckMode, headers: [String: String]?)`
  - `send(body: String, to: String, receiptId: String?, headers: [String: String]?)`

#### åƒæ•¸åç¨± vs STOMP Frame Header
- **å­¸ç¿’**: Swift æ–¹æ³•åƒæ•¸åç¨±å’Œ STOMP å”è­°çš„ header åç¨±æ˜¯ä¸åŒçš„æ¦‚å¿µ
- **ç¯„ä¾‹**: 
  - Swift API: `unsubscribe(from: String)` - `from` æ˜¯åƒæ•¸åç¨±
  - STOMP Frame: `UNSUBSCRIBE id:{subscriptionId}` - `id` æ˜¯ STOMP header
  - å¯¦éš›ç™¼é€: `SportyStomp` å…§éƒ¨æœƒå°‡ `from` åƒæ•¸çš„å€¼æ”¾å…¥ `id` header

### 3. API Spec å…¼å®¹æ€§

#### accept-version æ ¼å¼
- **API Spec è¦æ±‚**: `accept-version:1,2,1,1,1.0`
- **SportyStomp é»˜èª**: `"1.1,1.2"`
- **ç‹€æ…‹**: âš ï¸ å¾…é©—è­‰
- **TODO**: æ¸¬è©¦ `connectWithCustomHeaders(acceptVersion: "1,2,1,1,1.0")` æ˜¯å¦æ­£å¸¸å·¥ä½œ

#### heart-beat header
- **API Spec è¦æ±‚**: `heart-beat:4000,4000` (åœ¨ CONNECT frame ä¸­)
- **SportyStomp**: ä½¿ç”¨ `enableAutoPing()` æä¾› WebSocket å±¤çš„ ping
- **ç‹€æ…‹**: âš ï¸ å¾…é©—è­‰
- **TODO**: ç¢ºèªæœå‹™ç«¯æ˜¯å¦éœ€è¦ STOMP å±¤çš„ heart-beat header

#### è¨Šæ¯æ ¼å¼é©—è­‰
- **API Spec è¦æ±‚**: `{"type":"MESSAGE","data":{...}}`
- **å¯¦ä½œ**: å·²å¯¦ä½œè§£æé‚è¼¯ï¼ŒåŒ…å« fallback è™•ç†
- **ç‹€æ…‹**: âš ï¸ å¾…é©—è­‰å¯¦éš›æ¥æ”¶åˆ°çš„è¨Šæ¯æ ¼å¼

### 4. æ¸¬è©¦èˆ‡é©—è­‰

#### TDD ä¸€è‡´æ€§æª¢æŸ¥
- **å®Œæˆåº¦**: 95%
- **ä¸»è¦ç¼ºå¤±**: ç¼ºå°‘ `ChatWebSocketClient` å–®å…ƒæ¸¬è©¦
- **å»ºè­°**: æ·»åŠ  `ChatWebSocketClientTests.swift`ï¼Œè¦†è“‹ç‡ç›®æ¨™ â‰¥ 80%

#### æ¸¬è©¦è¦†è“‹ç¯„åœ
- **éœ€è¦æ¸¬è©¦**:
  - é€£ç·šç®¡ç†ï¼ˆæˆåŠŸ/å¤±æ•—å ´æ™¯ï¼‰
  - è¨‚é–±ç®¡ç†ï¼ˆå–®ä¸€/å¤šè¨‚é–±è€…ï¼‰
  - è¨Šæ¯æ¥æ”¶èˆ‡è§£æ
  - é‡é€£æ©Ÿåˆ¶ï¼ˆæŒ‡æ•¸é€€é¿ï¼‰
  - éŒ¯èª¤è™•ç†

---

## ğŸ”§ æ”¹é€²å»ºè­° / Improvement Suggestions

### 1. å„ªå…ˆç´šï¼šé«˜ / Priority: High

#### 1.1 æ·»åŠ å–®å…ƒæ¸¬è©¦
- **æª”æ¡ˆ**: `MatchChat/Tests/MatchChatTests/ChatWebSocketClientTests.swift`
- **æ¸¬è©¦é …ç›®**:
  - é€£ç·šç®¡ç†ï¼ˆæˆåŠŸ/å¤±æ•—å ´æ™¯ï¼‰
  - è¨‚é–±ç®¡ç†ï¼ˆå–®ä¸€/å¤šè¨‚é–±è€…ï¼‰
  - è¨Šæ¯æ¥æ”¶èˆ‡è§£æ
  - é‡é€£æ©Ÿåˆ¶ï¼ˆæŒ‡æ•¸é€€é¿ï¼‰
  - éŒ¯èª¤è™•ç†
- **ç›®æ¨™**: è¦†è“‹ç‡ â‰¥ 80%

#### 1.2 é©—è­‰ API Spec å…¼å®¹æ€§
- **é …ç›®**:
  - æ¸¬è©¦ `accept-version: "1,2,1,1,1.0"` æ˜¯å¦æ­£å¸¸å·¥ä½œ
  - ç¢ºèªæœå‹™ç«¯æ˜¯å¦éœ€è¦ STOMP å±¤çš„ `heart-beat` header
  - é©—è­‰å¯¦éš›æ¥æ”¶åˆ°çš„è¨Šæ¯æ ¼å¼æ˜¯å¦ç¬¦åˆ API Spec
- **æ–¹æ³•**: Integration Test

### 2. å„ªå…ˆç´šï¼šä¸­ / Priority: Medium

#### 2.1 æ›´æ–°æ–¹æ³•è¨»è§£
- **æª”æ¡ˆ**: `ChatWebSocketClient.swift`
- **é …ç›®**: æ›´æ–° `unsubscribe(subscriberId:)` çš„è¨»è§£
- **å…§å®¹**: èªªæ˜ç•¶å‰å¯¦ä½œå·²ç¶“è§£æ±ºäº† AsyncStream subscriberId çš„å•é¡Œ

#### 2.2 æ·»åŠ  Integration Test
- **æª”æ¡ˆ**: `MatchChat/Tests/MatchChatIntegrationTests/ChatWebSocketClientIntegrationTests.swift`
- **æ¸¬è©¦é …ç›®**: å¯¦éš› WebSocket é€£ç·šã€è¨‚é–±ã€è¨Šæ¯æ¥æ”¶

### 3. å„ªå…ˆç´šï¼šä½ / Priority: Low

#### 3.1 ä»£ç¢¼å„ªåŒ–
- **é …ç›®**:
  - è€ƒæ…®å°‡ `extractChatroomId()` æ”¹ç‚ºæ›´å¥å£¯çš„æ­£å‰‡è¡¨é”å¼è§£æ
  - è€ƒæ…®æ·»åŠ æ›´è©³ç´°çš„éŒ¯èª¤æ—¥èªŒ

---

## ğŸ“ å°è©±æ‘˜è¦ / Conversation Summary

### ä¸»è¦å·¥ä½œæµç¨‹

1. **ä¿®å¾© ChatWebSocketClient éŒ¯èª¤**
   - ä¿®å¾© `SportyStomp` API èª¿ç”¨éŒ¯èª¤ï¼ˆåƒæ•¸åç¨±å’Œé¡å‹ï¼‰
   - è§£æ±ºä¸¦ç™¼ç›¸é—œçš„æ•¸æ“šç«¶çˆ­è­¦å‘Š
   - æ·»åŠ å¿…è¦çš„ä¾è³´å’Œ Sendable conformance

2. **ç†è§£æŠ€è¡“é¸å‹**
   - ç¢ºèªä½¿ç”¨ `SportyStomp` çš„åŸå› ï¼ˆå·²æœ‰åƒè€ƒå¯¦ä½œã€TDD æŒ‡å®šï¼‰
   - ç†è§£ `actor` vs `class` çš„é¸æ“‡
   - ç†è§£ `AsyncStream` vs `callback` çš„é¸æ“‡

3. **API Spec å…¼å®¹æ€§æª¢æŸ¥**
   - æª¢æŸ¥ `SportyStomp` æ˜¯å¦æ»¿è¶³ API Spec è¦æ±‚
   - è­˜åˆ¥éœ€è¦é©—è­‰çš„é …ç›®ï¼ˆaccept-versionã€heart-beatã€è¨Šæ¯æ ¼å¼ï¼‰
   - æ·»åŠ  TODO è¨»è§£æ¨™è¨˜

4. **TDD ä¸€è‡´æ€§æª¢æŸ¥**
   - ç”Ÿæˆä¸€è‡´æ€§æª¢æŸ¥å ±å‘Š
   - è­˜åˆ¥å¯¦ä½œå®Œæˆåº¦ï¼ˆ95%ï¼‰
   - è­˜åˆ¥ç¼ºå¤±é …ç›®ï¼ˆå–®å…ƒæ¸¬è©¦ï¼‰

5. **æ–‡æª”éƒ¨ç½²**
   - éƒ¨ç½² TDD æ–‡æª”åˆ° GitHub Pages
   - æˆåŠŸæ¨é€åˆ° `gh-pages` branch

### é—œéµæŠ€è¡“æ±ºç­–

- âœ… ä½¿ç”¨ `SportyStomp` æ¡†æ¶ï¼ˆå·²æœ‰ã€æˆç†Ÿã€ç¬¦åˆéœ€æ±‚ï¼‰
- âœ… ä½¿ç”¨ `actor` ç¢ºä¿ç·šç¨‹å®‰å…¨
- âœ… ä½¿ç”¨ `AsyncStream` æä¾›è¨Šæ¯æµ
- âœ… ä½¿ç”¨ `nonisolated` + `Task` è™•ç† delegate å›èª¿
- âœ… ç‚ºå¤–éƒ¨åº« enum æ·»åŠ  `@unchecked @retroactive Sendable`

### å¾…å®Œæˆé …ç›®

- âš ï¸ æ·»åŠ  `ChatWebSocketClient` å–®å…ƒæ¸¬è©¦
- âš ï¸ é©—è­‰ API Spec å…¼å®¹æ€§ï¼ˆIntegration Testï¼‰
- âš ï¸ æ›´æ–°æ–¹æ³•è¨»è§£

---

## ğŸ”— ç›¸é—œæ–‡ä»¶ / Related Documents

- **TDD Ticket**: `12_Tickets/03_client/TDD-022_ChatWebSocketClient.md`
- **ä¸€è‡´æ€§æª¢æŸ¥å ±å‘Š**: `13_Implementation_Status/TDD-022_ChatWebSocketClient_Consistency_Check.md`
- **å¯¦ä½œæª”æ¡ˆ**: `MatchChat/Sources/MatchChat/Services/API/ChatWebSocketClient.swift`
- **API Spec**: `08_API Spec & Mapping/01_api_spec.md`
- **è¨­è¨ˆæ–¹æ¡ˆ**: `16_Cursor_Workflow/daily_plans/2025-12-03_websocket_design.md`

---

**ç”Ÿæˆæ™‚é–“**: 2025-12-03  
**ä¸‹æ¬¡æ›´æ–°**: å®Œæˆå–®å…ƒæ¸¬è©¦å¾Œ








